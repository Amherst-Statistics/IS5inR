---
title: "IS5 in R: Relationships Between Categorical Variables--Contingency Tables (Chapter 3)"
author: "Margaret Chien and Nicholas Horton (nhorton@amherst.edu)"
date: "June 16, 2018"
output: 
  pdf_document:
    fig_height: 4
    fig_width: 6
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 4
    fig_width: 6
---


```{r, include = FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
library(mosaic)
library(readr)
library(janitor)
```

```{r, include = FALSE}
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy = FALSE,     # display code as typed
  size = "small"    # slightly smaller font for code
)
```

## Introduction and background 

This document is intended to help describe how to undertake analyses introduced 
as examples in the Fifth Edition of *Intro Stats* (2018) by De Veaux, Velleman, and Bock.
More information about the book can be found at http://wps.aw.com/aw_deveaux_stats_series.  This
file as well as the associated R Markdown reproducible analysis source file used to create it can be found at http://nhorton.people.amherst.edu/is5.

This work leverages initiatives undertaken by Project MOSAIC (http://www.mosaic-web.org), an NSF-funded effort to improve the teaching of statistics, calculus, science and computing in the undergraduate curriculum. In particular, we utilize the `mosaic` package, which was written to simplify the use of R for introductory statistics courses. A short summary of the R needed to teach introductory statistics can be found in the mosaic package vignettes (http://cran.r-project.org/web/packages/mosaic).  A paper describing the mosaic approach was published in the *R Journal*: https://journal.r-project.org/archive/2017/RJ-2017-024.

## Chapter 3: Relationships Between Categorical Variables--Contingency Tables

### Section 3.1: Contingency Tables

```{r}
library(mosaic)
library(readr)
library(janitor)
OKCupid <- read_csv("http://nhorton.people.amherst.edu/is5/data/OKCupid_CatsDogs.csv", skip = 1) %>%
  clean_names()
# If you look at the data set, you'll see that the first line is "Col1", "Col2", etc
tally(~ cats_dogs_both + gender, margin = TRUE, data = OKCupid)
tally(~ cats_dogs_both + gender, format = "percent", margin = TRUE, data = OKCupid)
tally(~ cats_dogs_both | gender, format = "percent", margin = TRUE, data = OKCupid)
tally(~ gender | cats_dogs_both, format = "percent", margin = TRUE, data = OKCupid)
```

#### Example 3.1: Exploring Marginal Distributions

```{r}
SuperBowl <- read_csv("http://nhorton.people.amherst.edu/is5/data/Watch_the_Super_bowl.csv", skip = 1)
tally(~ Plan + Sex, data = SuperBowl)
```

#### Example 3.2: Exploring Percentages: Children and First-Class Ticket Holders First?

```{r}
Titanic <- read_csv("http://nhorton.people.amherst.edu/is5/data/Titanic.csv")
tally(~ Class + Survived, format = "percent", margin = TRUE, data = Titanic)
tally(~ Survived | Class, format = "percent", margin = TRUE, data = Titanic)
tally(~ Class | Survived, format = "percent", margin = TRUE, data = Titanic)
```

### Section 3.2: Conditional Distributions

See displays on 68-69.

```{r}
gf_bar(~ cats_dogs_both | gender, data = OKCupid)
#There are many who don't own either
gf_bar(~ cats_dogs_both | gender, data = filter(OKCupid, cats_dogs_both != "NA"))
```

#### Example 3.3: Finding Conditional Distributions: Watching the Super Bowl

```{r}
tally(~ Plan + Sex, margin = TRUE, data = SuperBowl)
tally(~ Plan | Sex, format = "percent", data = SuperBowl)
```

#### Example 3.4: Looking for Associations Between Variables: Still Watching the Super Bowl

```{r}
gf_bar(~ Plan | Sex, format = "percent", data = SuperBowl)
```

#### Examining Contingency Tables

See displays on page 72.  

```{r}
FishDiet <- read_csv("http://nhorton.people.amherst.edu/is5/data/Fish_diet.csv", skip = 1) %>%
  clean_names()
tally(~ diet_counts + cancer_counts, data = FishDiet)
```

#### Random Matters

Seee display on page 74.

```{r}
Nightmares <- read_csv("http://nhorton.people.amherst.edu/is5/data/Nightmares.csv", skip = 1)
Nightmares <- Nightmares %>%
  mutate(Dream = ifelse(Dream == "N", "Nightmare", "SweetDreams"))
tally(~ Side + Dream, data = Nightmares)
```

### Section 3.3: Displaying Contingency Tables

```{r}
tally(~ Class + Survived, format = "count", data = Titanic)
tally(~ Class + Survived, format = "percent", data = Titanic)
barplot(tally(~ Survived | Class, format = "percent", data = Titanic), beside = TRUE)
barplot(tally(~ Class | Survived, format = "percent", data = Titanic))
gf_bar(~ Survived | Class, format = "percent", data = Titanic)
#gf_bar automatically facets
```

```{r}
vcd::mosaic(tally(~ Survived + Class, data = Titanic), 
           main = "Mosaic plot of Class by Survival",
           shade = TRUE)
```

See the mosaic plots on page 77.  

### Section 3.4: Three Categorical Variables

```{r}
tally(~ gender + cats_dogs_both + drugs_y_n, format = "percent", data = OKCupid)
```

#### Example 3.7: Looking for Associations Among Three Variables at Once

```{r}
vcd::mosaic(tally(~ Sex + Survived + Class, data = Titanic), shade = TRUE)
```

#### Example 3.8: Simpson's Paradox: Gender Discrimination?

See tables on page 80.  

```{r}
# Two ways to create a data frame
Berk_2 <- rbind(
  do(512) * data.frame(admit = TRUE, sex = "M", school = "A"),
  do(313) * data.frame(admit = TRUE, sex = "M", school = "B"),
  do(120) * data.frame(admit = TRUE, sex = "M", school = "C"),
  do(138) * data.frame(admit = TRUE, sex = "M", school = "D"),
  do(53) * data.frame(admit = TRUE, sex = "M", school = "E"),
  do(22) * data.frame(admit = TRUE, sex = "M", school = "F"),
  do(316) * data.frame(admit = FALSE, sex = "M", school = "A"),
  do(206) * data.frame(admit = FALSE, sex = "M", school = "B"),
  do(205) * data.frame(admit = FALSE, sex = "M", school = "C"),
  do(278) * data.frame(admit = FALSE, sex = "M", school = "D"),
  do(138) * data.frame(admit = FALSE, sex = "M", school = "E"),
  do(350) * data.frame(admit = FALSE, sex = "M", school = "F"),
  do(89) * data.frame(admit = TRUE, sex = "F", school = "A"), 
  do(17) * data.frame(admit = TRUE, sex = "F", school = "B"),
  do(202) * data.frame(admit = TRUE, sex = "F", school = "C"), 
  do(131) * data.frame(admit = TRUE, sex = "F", school = "D"),
  do(94) * data.frame(admit = TRUE, sex = "F", school = "E"),
  do(24) * data.frame(admit = TRUE, sex = "F", school = "F"),
  do(16) * data.frame(admit = FALSE, sex = "F", school = "A"),
  do(8) * data.frame(admit = FALSE, sex = "F", school = "B"),
  do(391) * data.frame(admit = FALSE, sex = "F", school = "C"),
  do(245) * data.frame(admit = FALSE, sex = "F", school = "D"),
  do(300) * data.frame(admit = FALSE, sex = "F", school = "E"),
  do(318) * data.frame(admit = FALSE, sex = "F", school = "F") 
)  # some numbers are off but it's really annoying to fix

tally(~ sex + admit, data = Berk_2)
tally(~ sex + school + admit, data = Berk_2)

admit <- c(rep("TRUE", 1158), rep("FALSE", 1493), rep("TRUE", 557), rep("FALSE", 1278))
sex <- c(rep("M", 1158 + 1493), rep("F", 557 + 1278))
school <- c(rep("A", 512), rep("B", 313), rep("C", 120),
            rep("D", 138), rep("E", 53), rep("F", 22),
            rep("A", 512/.621 - 512), rep("B", 313/.602 - 313), 
            rep("C", 120/.369 - 120), rep("D", 138/.331 - 138), 
            rep("E", 53/.277 - 53), rep("F", 22/.059 - 22),
            rep("A", 89), rep("B", 17), rep("C", 202),
            rep("D", 131), rep("E", 94), rep("F", 24), 
            rep("A", 89/.824 - 89 + 1), rep("B", 17/.68 - 17 + 1), 
            rep("C", 202/.341 - 202 + 1), rep("D", 131/.349 - 131 + 1), 
            rep("E", 94/.239 - 94 + 1), rep("F", 24/.07 - 24)) # + 1 because the rows weren't matching up
Berk <- data.frame(sex, admit, school)
tally(~ sex + admit, data = Berk)
tally(~ sex + school + admit, data = Berk)
```
