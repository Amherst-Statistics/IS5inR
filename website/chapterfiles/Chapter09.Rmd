---
title: "IS5 in R: Multiple Regression (Chapter 9)"
author: "Margaret Chien and Nicholas Horton (nhorton@amherst.edu)"
date: "June 27, 2018"
output: 
  pdf_document:
    fig_height: 4
    fig_width: 6
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 4
    fig_width: 6
---


```{r, include = FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
library(mosaic)
library(readr)
library(janitor)
```

```{r, include = FALSE}
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy = FALSE,     # display code as typed
  size = "small"    # slightly smaller font for code
)
```

## Introduction and background 

This document is intended to help describe how to undertake analyses introduced 
as examples in the Fifth Edition of *Intro Stats* (2018) by De Veaux, Velleman, and Bock.
More information about the book can be found at http://wps.aw.com/aw_deveaux_stats_series.  This
file as well as the associated R Markdown reproducible analysis source file used to create it can be found at http://nhorton.people.amherst.edu/is5.

This work leverages initiatives undertaken by Project MOSAIC (http://www.mosaic-web.org), an NSF-funded effort to improve the teaching of statistics, calculus, science and computing in the undergraduate curriculum. In particular, we utilize the `mosaic` package, which was written to simplify the use of R for introductory statistics courses. A short summary of the R needed to teach introductory statistics can be found in the mosaic package vignettes (http://cran.r-project.org/web/packages/mosaic).  A paper describing the mosaic approach was published in the *R Journal*: https://journal.r-project.org/archive/2017/RJ-2017-024.

## Chapter 9: Multiple Regression

```{r}
library(mosaic)
library(readr)
library(janitor)
BodyFat <- read_csv("http://nhorton.people.amherst.edu/is5/data/Bodyfat.csv") %>%
  clean_names()
# Figure 9.1, page 276
gf_point(pct_bf ~ waist, data = BodyFat) %>%
  gf_labs(x = "Waist", y = "% Body Fat")
```

By default, `read_csv()` prints the variable names. These messages can be suppressed using the `message = FALSE` code chunk option to save space and improve readability.  
Here we use the `clean_names()` function from the `janitor` package to sanitize the names of the columns (which would otherwise contain special characters or whitespace).   

### Section 9.1: What is Multiple Regression?

#### Example 9.1: Modeling Home Prices

```{r}
RealEstate <- read_csv("http://nhorton.people.amherst.edu/is5/data/Real_Estate.csv") %>%
  clean_names()
msummary(lm(price ~ living_area + bedrooms, data = RealEstate))
```

The coefficients for the model can be seen in the `Estimate` column.  

### Section 9.2: Interpreting Multiple Regression Coefficients

```{r}
# Figure 9.2, page 279
gf_point(pct_bf ~ height, data = BodyFat) %>%
  gf_labs(x = "Height (in)", y = "% Body Fat")
# Figure 9.3
BodyFat %>%
  filter(waist >= 36 & waist <= 38) %>%
  gf_point(pct_bf ~ height) %>%
  gf_labs(x = "Height (in)", y = "% Body Fat") %>%
  gf_lm()
```

### Section 9.3: The Multiple Regression Model--Assumptions and Conditions

#### Linearity Assumption

#### Equal Variance Assumption

```{r}
bodyfatlm <- lm(pct_bf ~ waist + height, data = BodyFat)
# Figure 9.4, page 282
gf_point(resid(bodyfatlm) ~ fitted(bodyfatlm)) %>%
  gf_labs(x = "Predicted", y = "Residuals")
```

#### Check the Residuals

```{r}
# Figure 9.5
gf_histogram(~ resid(bodyfatlm), binwidth = 1.5, center = 0.75) %>%
  gf_labs(x = "Residuals", y = "Counts")
gf_qq(~ resid(bodyfatlm)) %>%
  gf_labs(x = "Normal Scores", y = "Residuals (% Body Fat)")
```

#### Step-By-Step Example: Multiple Regression

```{r}
HousingPrices <- read_csv("http://nhorton.people.amherst.edu/is5/data/Housing_prices.csv") %>%
  clean_names()
gf_point(price ~ living_area, data = HousingPrices) %>%
  gf_labs(x = "Living Area", y = "Price")
gf_boxplot(price ~ as.factor(bedrooms), data = HousingPrices) %>%
  gf_labs(x = "Bedrooms", y = "Price")
gf_point(price ~ age, data = HousingPrices) %>%
  gf_labs(x = "Age", y = "Price")
gf_point(price ~ log(age + 1), data = HousingPrices) %>%
  gf_labs(x = "LogAge", y = "Price")
housinglm <- lm(price ~ log(age + 1), data = HousingPrices)
gf_point(resid(housinglm) ~ fitted(housinglm)) %>%
  gf_labs(x = "Predicted Values", y = "Residuals")
housinglm2 <- lm(price ~ living_area + log(age + 1) + bedrooms, data = HousingPrices)
msummary(housinglm2)
```

### Section 9.4: Partial Regression Plots

```{r}
# Figure 9.6
justheightlm <- lm(pct_bf ~ height, data = BodyFat)
# multiplelm <- lm(pct_bf ~ waist + height, data = BodyFat)
gf_point(resid(multiplelm) ~ resid(justheightlm))
# Not sure what the multiple regression is for predicting % Body Fat (currently using the one I made before with waist and height, but it doesn't match the one in the book)
```

#### Just Checking

```{r}
Hurricanes <- read_csv("http://nhorton.people.amherst.edu/is5/data/Hurricanes_2015.csv") %>%
  clean_names()
hurricanelm <- lm(max_wind_speed_kts ~ year + central_pressure_mb, data = Hurricanes)
msummary(hurricanelm)
```

### Section 9.5: Indicator Variables

```{r}
Coasters <- read_csv("http://nhorton.people.amherst.edu/is5/data/Coasters_2015.csv")
# Table 9.2, page 288
head(Coasters)
# Figure 9.7
# Coasters[72, ], Tower of Terror isn't included by the book
Coasters <- Coasters %>%
  filter(Name != "Tower of Terror")
gf_point(Duration ~ Drop, data = Coasters) %>%
  gf_lm()
coasterlm <- lm(Duration ~ Drop, data = Coasters)
gf_point(resid(coasterlm) ~ fitted(coasterlm)) %>%
  gf_labs(x = "Predicted", y = "Residuals")
msummary(coasterlm)
# Figure 9.8
gf_point(Duration ~ Drop, color = ~ as.factor(Inversions), data = Coasters) %>%
  gf_lm() %>%
  gf_labs(color = "Inversions") 
coasterlm2 <- lm(Duration ~ Drop + as.factor(Inversions), data = Coasters)
msummary(coasterlm2)
gf_point(resid(coasterlm2) ~ fitted(coasterlm2)) %>%
  gf_labs(x = "Predicted", y = "Residuals") # not sure how to add Inversions
```

#### Example 9.3: Using Indicator Variables

```{r}
DirtBikes <- read_csv("http://nhorton.people.amherst.edu/is5/data/Dirt_bikes_2014.csv")
DirtBikes <- DirtBikes %>%
  filter(Cooling != "NA") %>%
  mutate(Cooling = ifelse(Cooling == "Air-Cooled", "Air-Cooled", "LiquidCooled"))
gf_point(MSRP ~ (Displacement)^(1/3), color = ~ Cooling, data = DirtBikes) %>%
  gf_lm()
bikeslm <- lm(MSRP ~ I(Displacement^(1/3)) + Cooling, data = DirtBikes)
msummary(bikeslm)
```

`I()`  

#### Adjusting for Different Slopes

```{r}
BurgerKing <- read_csv("http://nhorton.people.amherst.edu/is5/data/Burger_King_items.csv") %>%
  clean_names()
# Figure 9.9, page 292
gf_point(calories ~ carbs_g, data = BurgerKing) %>%
  gf_labs(x = "Carbs (g)", y = "Calories")
# Figure 9.10
gf_point(calories ~ carbs_g, color = ~ as.factor(meat), data = BurgerKing) %>%
  gf_labs(x = "Carbs (g)", y = "Calories", color = "Meat")
msummary(lm(calories ~ carbs_g * as.factor(meat), data = BurgerKing))
```

#### One, Two, Many

```{r}
Cereal <- read_csv("http://nhorton.people.amherst.edu/is5/data/Cereals.csv")
cereallm <- lm(sugars ~ sodium + as.factor(shelf), data = Cereal)
gf_point(sugars ~ sodium, color = ~ as.factor(shelf), data = Cereal) %>%
  gf_lm() %>%
  gf_labs(x = "Sodium", y = "Sugars", color = "Shelf")
msummary(cereallm)
```

#### Example 9.4: Indicators for Variables with Several Levels

```{r}
Diamonds <- read_csv("http://nhorton.people.amherst.edu/is5/data/Diamonds.csv") %>%
  clean_names()
diamondlm <- lm(sqrt(price) ~ carat_size + color, data = Diamonds)
msummary(diamondlm)
diamondpredict <- makeFun(diamondlm)
#gf_point(sqrt(price) ~ carat_size, color = ~ color, data = Diamonds) %>%
#  gf_line(diamondpredict(color = "D")) %>%
#  gf_labs(x = "Carat Size", y = "sqrt(Price)") +
#  ylim(30, 100)

# Parallel slopes currently not working

#evals %>%
#  mutate(gender = forcats::fct_relevel(gender, "male")) %>%
#  gf_point(score ~ bty_avg, data = ., color = ~ gender, xlab = "Avg Beauty Score", ylab = "Avg Professor Evaluation Score") %>% 
#    gf_line(lin_predict(bty_avg, gender = "female") ~ bty_avg, color = ~ "female") %>%
#    gf_line(lin_predict(bty_avg, gender = "male") ~ bty_avg, color = ~ "male") 



diamondlm2 <- lm(sqrt(price) ~ carat_size * color, data = Diamonds)
msummary(diamondlm2)
gf_point(sqrt(price) ~ carat_size, color = ~ color, data = Diamonds) %>%
  gf_lm() %>%
  gf_labs(x = "Carat Size", y = "sqrt(Price)") +
  ylim(30, 100)
```