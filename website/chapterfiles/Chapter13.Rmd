---
title: "IS5 in R: Sampling Distribution Models and Confidence Intervals for Proportions (Chapter 13)"
author: "Margaret Chien and Nicholas Horton (nhorton@amherst.edu)"
date: "July 11, 2018"
output: 
  pdf_document:
    fig_height: 3
    fig_width: 5
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 4
    fig_width: 6
---


```{r, include = FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
library(mosaic)
library(readr)
library(janitor)
```

```{r, include = FALSE}
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy = FALSE,     # display code as typed
  size = "small"    # slightly smaller font for code
)
```

## Introduction and background 

This document is intended to help describe how to undertake analyses introduced 
as examples in the Fifth Edition of *Intro Stats* (2018) by De Veaux, Velleman, and Bock.
More information about the book can be found at http://wps.aw.com/aw_deveaux_stats_series.  This
file as well as the associated R Markdown reproducible analysis source file used to create it can be found at http://nhorton.people.amherst.edu/is5.

This work leverages initiatives undertaken by Project MOSAIC (http://www.mosaic-web.org), an NSF-funded effort to improve the teaching of statistics, calculus, science and computing in the undergraduate curriculum. In particular, we utilize the `mosaic` package, which was written to simplify the use of R for introductory statistics courses. A short summary of the R needed to teach introductory statistics can be found in the mosaic package vignettes (http://cran.r-project.org/web/packages/mosaic).  A paper describing the mosaic approach was published in the *R Journal*: https://journal.r-project.org/archive/2017/RJ-2017-024.

## Chapter 13: Sampling Distribution Models and Confidence Intervals for Proportions

```{r}
library(mosaic)
library(readr)
library(janitor)
Babies <- read_csv("http://nhorton.people.amherst.edu/is5/data/Babysamp_98.csv") %>%
  clean_names()
```

By default, `read_csv()` prints the variable names. These messages can be suppressed using the `message=FALSE` code chunk option to save space and improve readability.  
Here we use the `clean_names()` function from the `janitor` package to sanitize the names of the columns (which would otherwise contain special characters or whitespace).   

```{r}
# Figure 13.1, page 411
gf_histogram(~ gestation, binwidth = 1, center = .5, fill = ~ preemie, data = Babies) %>%
  gf_labs(x = "Gestation Time (weeks)", y = "Births", fill = "")
```

### Section 13.1: The Sampling Distribution Model for a Proportion

#### The Normal Model

### Section 13.2: When Does the Normal Model Work? Assumptions and Conditions

#### Random Matters: Does the Normal Model Always Work? Sampling Distributions for Other Statistics

```{r}
# page 418
BodyFat <- read_csv("http://nhorton.people.amherst.edu/is5/data/Bodyfat.csv") %>%
  clean_names()
set.seed(3245) # For reproducibility
numsim <- 1000  # Number of samples

# What does do() do?
favstats(~ weight, data = sample(BodyFat, 10)) # favstats of one random sample of 10
favstats(~ weight, data = sample(BodyFat, 10)) # favstats of another random sample

do(2) * favstats(~ weight, data = sample(BodyFat, 10)) # finds favstats twice

# For the visualization, we need 1,000 favstats
bodyfatsamples <- do(numsim) * favstats(~ weight, data = sample(BodyFat, 10))
```

Here, the `do()` function finds, 1,000 times, the `favstats()` of a random sample of 10 `BodyFat` weights. 

```{r}
bodyfatsamples <- bodyfatsamples %>%
  clean_names()
names(bodyfatsamples)
gf_histogram(~ median, data = bodyfatsamples, binwidth = 3, center = 1.5) %>%
  gf_labs(x = "Medians", y = "# of Samples")
gf_histogram(~ sd^2, data = bodyfatsamples) %>%
  gf_labs(x = "Variance", y = "# of Samples")
gf_histogram(~ min, data = bodyfatsamples, binwidth = 3, center = 1.5) %>%
  gf_labs(x = "Minimums", y = "# of Samples")
```

### Section 13.3: A Confidence Interval for a Proportion

### Section 13.4: Interpreting Confidence Intervals: What Does 95% Confidence Really Mean?

```{r}
# Here is a simulation of Figure 13.9 (page 422)
set.seed(118)
CIsim(n = 100, samples = 20) # We expect 19/20 intervals to cover the true mean
```

We expect 19 of the 20 intervals to cover the true mean, but since only 20 samples are drawn, there is more variability. Here, only 18 out of the 20 intervals cover the true mean.  

To get the actual plot, the code is more complicated.  

```{r}
findingpoints <- function(sampsize, numsamp) {
  set.seed(2461)
  CIdata <- do(numsamp) * t.test(~ preemie, data = sample(Babies, size = sampsize))
  CIdata <- CIdata %>%
    select(lower, upper) %>%
    mutate(mean = (upper - lower)/2)
}

ConfData <- findingpoints(sampsize = 100, numsamp = 20)

gf_point(mean ~ (1:20), data = ConfData) #%>%
#  gf_line
```

### Section 13.5: Margin of Error: Certainty vs. Precision

### Section 13.6: Choosing the Sample Size