---
title: "IS5 in R: Comparing Groups (Chapter 17)"
author: "Margaret Chien and Nicholas Horton (nhorton@amherst.edu)"
date: "July 16, 2018"
output: 
  pdf_document:
    fig_height: 3
    fig_width: 5
  html_document:
    fig_height: 3
    fig_width: 5
  word_document:
    fig_height: 4
    fig_width: 6
---


```{r, include = FALSE}
# Don't delete this chunk if you are using the mosaic package
# This loads the mosaic and dplyr packages
library(mosaic)
library(readr)
library(janitor)
```

```{r, include = FALSE}
# knitr settings to control how R chunks work.
require(knitr)
opts_chunk$set(
  tidy = FALSE,     # display code as typed
  size = "small"    # slightly smaller font for code
)
```

## Introduction and background 

This document is intended to help describe how to undertake analyses introduced 
as examples in the Fifth Edition of *Intro Stats* (2018) by De Veaux, Velleman, and Bock.
More information about the book can be found at http://wps.aw.com/aw_deveaux_stats_series.  This
file as well as the associated R Markdown reproducible analysis source file used to create it can be found at http://nhorton.people.amherst.edu/is5.

This work leverages initiatives undertaken by Project MOSAIC (http://www.mosaic-web.org), an NSF-funded effort to improve the teaching of statistics, calculus, science and computing in the undergraduate curriculum. In particular, we utilize the `mosaic` package, which was written to simplify the use of R for introductory statistics courses. A short summary of the R needed to teach introductory statistics can be found in the mosaic package vignettes (http://cran.r-project.org/web/packages/mosaic).  A paper describing the mosaic approach was published in the *R Journal*: https://journal.r-project.org/archive/2017/RJ-2017-024.

## Chapter 17: Comparing Groups

```{r}
library(mosaic)
library(readr)
library(janitor)
```

### Section 17.1: A Confidence Interval for the Difference Between Two Proportions

```{r}
# Creating a data frame for Seatbelts
Seatbelts <- rbind(
  do(2777)        * data.frame(passenger = "F", belted = TRUE),
  do(4208 - 2777) * data.frame(passenger = "F", belted = FALSE),
  do(1363)        * data.frame(passenger = "M", belted = TRUE),
  do(2763 - 1363) * data.frame(passenger = "M", belted = FALSE)
) %>%
  select(passenger, belted)
```

The `do()` function constructs the correct rows for the data frame from the provided cell counts.

```{r cache=TRUE}
set.seed(234)
numsim <- 10000

# What does do() do?
resample(Seatbelts) %>%
  group_by(passenger) %>%
  summarise(proportion = sum(belted)/n()) %>%
  summarise(diffprop = abs(diff(proportion))) # Difference of proportions from one random resample
resample(Seatbelts) %>%
  group_by(passenger) %>%
  summarise(proportion = sum(belted)/n()) %>%
  summarise(diffprop = abs(diff(proportion))) # Difference of proportions from another random resample

do(2) * resample(Seatbelts) %>%
  group_by(passenger) %>%
  summarise(proportion = sum(belted)/n()) %>%
  summarise(diffprop = abs(diff(proportion))) # Calculates two differences

# We need numsim differences of proportions
seatbeltresamples <- do(numsim) * resample(Seatbelts) %>%
  group_by(passenger) %>%
  summarise(proportion = sum(belted)/n()) %>%
  summarise(diffprop = abs(diff(proportion)))

# Figure 17.1, page 542
gf_histogram(~ diffprop, data = seatbeltresamples) %>%
  gf_labs(x = "Difference of Proportions", y = "# of Resamples")
```

#### Example 17.1: Finding the Standard Error of a Difference in Proportions


XX MC: need to break up this block and add more annotation.

```{r}
# Creating the data set for online profiles
OnlineProf <- rbind(
  do(248 * .57)     * data.frame(gender = "M", profile = TRUE),
  do(248 * .43 + 1) * data.frame(gender = "M", profile = FALSE), # Add one for rounding errors
  do(256 * .70)     * data.frame(gender = "F", profile = TRUE),
  do(256 * .30 + 1) * data.frame(gender = "F", profile = FALSE)
)
tally(~ gender, data = OnlineProf)
OnlineProfM <- OnlineProf %>%
  filter(gender == "M")
sepboys <- ((mean(~ profile, data = OnlineProfM) * (1 - mean(~ profile, data = OnlineProfM)))/nrow(OnlineProfM))^.5
sepboys
OnlineProfF <- OnlineProf %>%
  filter(gender == "F")
sepgirls <- ((mean(~ profile, data = OnlineProfF) * (1 - mean(~ profile, data = OnlineProfF)))/nrow(OnlineProfF))^.5
sepgirls
sep <- (sepboys^2 + sepgirls^2)^.5
sep
```

#### Example 17.2: Finding a Two-Proportion *z*-Interval

```{r}
zstats <- qnorm(p = c(.025, .975))
(mean(~ profile, data = OnlineProfF) - mean(~ profile, data = OnlineProfM)) + zstats * sep
```

### Section 17.2: Assumptions and Conditions for Comparing Proportions

### Section 17.3: The Two-Sample *z*-Test: Testing for the Difference Between Proportions

#### Step-By-Step Example: A Two-Proportion *z*-Test

```{r}
# Create the data set
SleepHabits <- rbind(
  do(205)       * data.frame(gen = "GenY", internet = TRUE),
  do(293 - 205) * data.frame(gen = "GenY", internet = FALSE),
  do(235)       * data.frame(gen = "GenX", internet = TRUE),
  do(469 - 235) * data.frame(gen = "GenX", internet = FALSE)
)
```

```{r}
# Mechanics
ngeny <- nrow(filter(SleepHabits, gen == "GenY"))
ngeny
ygeny <- nrow(filter(SleepHabits, gen == "GenY"  & internet == TRUE))
ygeny
pgeny <- mean(~ internet, data = filter(SleepHabits, gen == "GenY"))
pgeny

ngenx <- nrow(filter(SleepHabits, gen == "GenX"))
ngenx
ygenx <- nrow(filter(SleepHabits, gen == "GenX"  & internet == TRUE))
ygenx
pgenx <- mean(~ internet, data = filter(SleepHabits, gen == "GenX"))
pgenx

sepgen <- ((pgeny * (1 - pgeny))/ngeny + (pgenx * (1 - pgenx))/ngenx)^.5
sepgen
pdiff <- pgeny - pgenx
pdiff
z <- (pdiff - 0)/sepgen
z
2 * pnorm(q = z, lower.tail = FALSE)
```

### Section 17.4: A Confidence Interval for the Difference Between Two Means

#### Example 17.7: Finding a Confidence Interval for the Difference in Sample Means

```{r}
# Not sure if creating data set is really necessary
# page 555
nord <- 27
nref <- 27
yord <- 8.5
yref <- 14.7
sord <- 6.1
sref <- 8.4

seys <- 2.0
diffy <- yref - yord # 6.2
tstats <- qt(p = c(.025, .975), df = 47.46)
tstats
me <- tstats * seys
me
diffy + me
```

### Section 17.5: The Two-Sample *t*-Test: Testing for the Difference Between Two Means

#### Step-By-Step Example: A Two-Sample *t*-Test for the Difference Between the Two Means

```{r}
# page 556
BuyingCam <- read_csv("http://nhorton.people.amherst.edu/is5/data/Buy_from_a_friend.csv")
```

By default, `read_csv()` prints the variable names. These messages can be suppressed using the `message=FALSE` code chunk option to save space and improve readability. 

```{r}
library(tidyr) # for gather() function
BuyingCam <- BuyingCam %>%
  gather(key = buying_type, value = amount_offered, Friend, Stranger)
# Model
gf_boxplot(amount_offered ~ buying_type, fill = ~ buying_type, data = BuyingCam) %>%
  gf_labs(x = "Buying From", y = "Amount Offered ($)", fill = "")
gf_histogram(~ amount_offered, binwidth = 25, center = 12.5, data = BuyingCam) %>% # doesn't exactly match
  gf_facet_wrap(buying_type ~ .) %>%
  gf_labs(x = "Amount Offered", y = "")
# Mechanics
favstats(~ amount_offered | buying_type, data = BuyingCam)
```

### Section 17.6: Randomization Tests and Confidence Intervals for Two Means

```{r}
Cars <- read_csv("http://nhorton.people.amherst.edu/is5/data/Car_speeds.csv")
# Figure 17.2 (page 560) is the same as Figure 4.4 (page 102)
favstats(~ speed | direction, data = Cars)
```

### Section 17.7: Pooling

### Section 17.8: The Standard Deviation of a Difference
